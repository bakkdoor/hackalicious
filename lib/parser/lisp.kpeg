#require "kpeg"

%% name = Lisp::Parser
%% {
  attr_accessor :something_cool
}

%% ast-location = ::Lisp::Parser::AST
%% comment = ast Comment(text)
%% number = ast Literal(value)
%% string = ast Literal(value)
%% symbol = ast Literal(value)
%% literal = ast Literal(value)
%% identifier = ast Identifier(name)
%% array_lit = ast ArrayLiteral(expressions)
%% expr_list = ast ExpressionList(expressions)
%% sexp = ast Sexp(expressions)
%% quote = ast Quote(expression)
%% unquote = ast Unquote(expression)
%% splice_unquote = ast SpliceUnquote(expression)

ALPHA = /[A-Za-z]/
DIGIT = /[0-9]/
operator = "." | "+" | "!" | "?" | "=" | "_" | "-" | ":" | "*" | "/"
lp = "("
rp = ")"
NL = "\n"
space = " " | "\t" | NL


comment = ";" < (!NL .)* > NL ~comment(text)
number = < /[0-9]+/ > { text }
integer_lit = number:n ~literal(n.to_i)
float_lit = number:w "." number:f ~literal("#{w}.#{f}".to_f)
true_lit = "true" ~literal(true)
false_lit = "false" ~literal(false)
nil_lit = "nil" ~literal(nil)
string_lit = '"' < (!'"' .)* > '"' ~string(text)
symbol_lit = ':' identifier:i ~symbol(i)
identifier = < (ALPHA | DIGIT | "_"| "-" | operator)+ > { text.to_sym }
array_lit = "[" (sexp | atom)*:e "]" ~array_lit(e)

programm = comment:c programm:p { p }
        | exp:e space* programm:p ~expr_list(p << e)
        | exp:e ~expr_list([e])

nested_expr = "(" expr:e ")" { e }

exp = space* exp:e space* { e }
    | sexp
    | atom

sexp = "(" space* ")" ~sexp([])
     | "(" exp+:s ")" ~sexp(s)

atom = space* atom:a space* { a }
     | literal

literal = integer_lit
        | array_lit
        | float_lit
        | true_lit
        | false_lit
        | nil_lit
        | string_lit
        | symbol_lit
        | identifier:i ~identifier(i)

root = programm:p { p }
